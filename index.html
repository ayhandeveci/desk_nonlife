<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Exam Viewer</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ------------ SOL PANEL ------------ */
    #sidebar {
      width: 300px;
      background: #f4f4f4;
      border-right: 1px solid #ddd;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="file"] {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #aaa;
      background: #fff;
    }

    button {
      width: 100%;
      padding: 10px;
      background: #fff;
      border: 1px solid #777;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #e7e7e7; }

    #fileList {
      flex: 1;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }

    .file-item {
      padding: 7px;
      margin-bottom: 5px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 13px;
    }

    .file-item:hover { background: #e7e7e7; }

    #status { font-size: 12px; color:#444; }

    /* ----------- SAĞ PANEL ----------- */
    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #ddd;
      overflow: hidden;
    }

    .title-bar {
      padding: 5px 10px;
      background: #f1f1f1;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
      font-weight: bold;
    }

    .img-holder {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: white;
    }

    img {
      max-width: 95%;
      max-height: 95%;
    }

    @media (max-width: 600px) {
      #sidebar { width: 200px; }
      button { font-size: 13px; padding: 8px; }
    }
  </style>

</head>
<body>

<!-- ---------------- SOL PANEL ---------------- -->
<div id="sidebar">

  <input id="saFile" type="file" accept="application/json">
  <button id="loadBtn">Soruları Yükle</button>
  <div id="status"></div>

  <div id="fileList"></div>

</div>

<!-- ---------------- SAĞ PANEL ---------------- -->
<div id="content">

  <div class="panel">
    <div class="title-bar" id="questionTitle">Soru</div>
    <div class="img-holder" id="questionView">
      <p>Seçilmedi</p>
    </div>
  </div>

  <div class="panel">
    <div class="title-bar" id="answerTitle">Cevap</div>
    <div class="img-holder" id="answerView">
      <p>Seçilmedi</p>
    </div>
  </div>

</div>

<script>
/* SABİT KLASÖR ID'LERİ */
const FOLDER_SORULAR = "1SM8NcS58qf-L9wOZ-ywZzg9gKhERZoK3";
const FOLDER_CEVAPLAR = "17IJCUY7xl52-YRyg7lP4FBJ-G3OohPx0";

/* CACHE */
let saCredentials = null;
let cachedToken = null;
let cachedTokenExp = 0;

let cacheSorular = [];
let cacheCevaplar = [];

/* ELEMENTLER */
const saFileInput = document.getElementById("saFile");
const loadBtn = document.getElementById("loadBtn");
const fileListDiv = document.getElementById("fileList");
const questionView = document.getElementById("questionView");
const answerView = document.getElementById("answerView");
const questionTitle = document.getElementById("questionTitle");
const answerTitle = document.getElementById("answerTitle");
const statusDiv = document.getElementById("status");

/* JSON YÜKLEME */
saFileInput.onchange = () => {
  const file = saFileInput.files[0];
  const r = new FileReader();
  r.onload = e => {
    saCredentials = JSON.parse(e.target.result);
    statusDiv.textContent = "JSON yüklendi.";
  };
  r.readAsText(file);
};

/* SORULARI YÜKLE + CACHE'E AT */
loadBtn.onclick = async () => {
  if (!saCredentials) {
    alert("Önce JSON yükle.");
    return;
  }

  statusDiv.textContent = "Sorular yükleniyor...";
  cacheSorular = await listPNGs(FOLDER_SORULAR);

  statusDiv.textContent = "Cevaplar yükleniyor...";
  cacheCevaplar = await listPNGs(FOLDER_CEVAPLAR);

  statusDiv.textContent = "Yüklendi.";
  drawList();
};


/* SOL LİSTEYİ ÇİZ */
function drawList() {
  fileListDiv.innerHTML = "";
  cacheSorular.forEach(f => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = f.name;
    d.onclick = () => showPair(f.name);
    fileListDiv.appendChild(d);
  });
}

/* SORU VE CEVABI BİRLİKTE GÖSTER */
async function showPair(fileName) {
  questionTitle.textContent = "Soru: " + fileName;
  answerTitle.textContent = "Cevap: " + fileName;

  questionView.innerHTML = "<p>Yükleniyor...</p>";
  answerView.innerHTML = "<p>Yükleniyor...</p>";

  const soru = cacheSorular.find(x => x.name === fileName);
  const cevap = cacheCevaplar.find(x => x.name === fileName);

  if (soru) {
    const img = await fetchPNG(soru.id);
    questionView.innerHTML = "";
    questionView.appendChild(img);
  } else {
    questionView.innerHTML = "<p>Soru bulunamadı.</p>";
  }

  if (cevap) {
    const img = await fetchPNG(cevap.id);
    answerView.innerHTML = "";
    answerView.appendChild(img);
  } else {
    answerView.innerHTML = "<p>Cevap bulunamadı.</p>";
  }
}

/* PNG İNDİR */
async function fetchPNG(id) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;

  const res = await fetch(url, { headers: { Authorization: "Bearer " + token }});
  const blob = await res.blob();

  const img = document.createElement("img");
  img.src = URL.createObjectURL(blob);
  return img;
}

/* PNG LİSTESİ */
async function listPNGs(folderId) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and mimeType='image/png'&fields=files(id,name)&pageSize=500`;

  const res = await fetch(url, { headers: { Authorization: "Bearer " + token }});
  return (await res.json()).files || [];
}

/* TOKEN ÜRETİMİ */
async function getToken() {
  const now = Math.floor(Date.now()/1000);
  if (cachedToken && cachedTokenExp - 60 > now)
    return cachedToken;

  const t = await createToken(saCredentials);
  cachedToken = t.access_token;
  cachedTokenExp = now + (t.expires_in || 3600);
  return cachedToken;
}

async function createToken(sa) {
  const now = Math.floor(Date.now()/1000);

  const header = { alg: "RS256", typ:"JWT" };
  const payload = {
    iss: sa.client_email,
    scope: "https://www.googleapis.com/auth/drive.readonly",
    aud: "https://oauth2.googleapis.com/token",
    exp: now + 3600,
    iat: now
  };

  const unsigned = b64(JSON.stringify(header)) + "." + b64(JSON.stringify(payload));

  const key = await crypto.subtle.importKey(
    "pkcs8",
    pemToBuf(sa.private_key),
    { name:"RSASSA-PKCS1-v1_5", hash:"SHA-256" },
    false,
    ["sign"]
  );

  const sig = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    key,
    new TextEncoder().encode(unsigned)
  );

  const jwt = unsigned + "." + b64Bytes(sig);

  const res = await fetch("https://oauth2.googleapis.com/token", {
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body: new URLSearchParams({
      grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt
    })
  });

  return await res.json();
}

/* HELPERLER */
function b64(str){
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
}

function b64Bytes(ab){
  let s="", b=new Uint8Array(ab);
  for(let i=0;i<b.length;i++) s+=String.fromCharCode(b[i]);
  return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
}

function pemToBuf(pem){
  const c=pem.replace(/-----BEGIN PRIVATE KEY-----/,"")
             .replace(/-----END PRIVATE KEY-----/,"")
             .replace(/\s+/g,"");
  const bin=atob(c);
  const buf=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) buf[i]=bin.charCodeAt(i);
  return buf.buffer;
}

</script>
</body>
</html>
