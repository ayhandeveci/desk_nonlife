<!DOCTYPE html>
<html lang="tr">

<head>
<meta charset="UTF-8">
<title>Exam Viewer - Soru Cevap</title>

<!-- MARKDOWN RENDER -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- MATHJAX -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [["$", "$"], ["\\(", "\\)"]],
    displayMath: [["$$", "$$"], ["\\[", "\\]"]]
  },
  svg: { fontCache: "global" }
};
</script>
<script id="MathJax-script" async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ÜST BAR */
  #topBar {
    position: absolute;
    top: 0;
    left: 0;
    height: 45px;
    width: 100%;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 5px 10px;
    background: #ddd;
    border-bottom: 1px solid #aaa;
    z-index: 3;
  }

  button, input[type="file"] {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #fff;
    font-size: 13px;
  }
  button:hover { background: #e7e7e7; }

  #status { font-size: 12px; margin-left: 10px; }

  #grid {
    margin-top: 45px;
    height: calc(100vh - 45px);
    width: 100vw;

    display: grid;
    grid-template-columns: 35% 65%;
    grid-template-rows: 50% 50%;
    grid-template-areas:
      "leftTop rightTop"
      "leftBottom rightBottom";
  }

  /* SOL ÜST PANEL */
  #leftTop {
    grid-area: leftTop;
    display: flex;
    flex-direction: row;
    background: #f3f3f3;
    border-right: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
  }

  .list-column {
    width: 50%;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }

  .list-title {
    font-weight: bold;
    padding: 8px;
    background: #e9e9e9;
    border-bottom: 1px solid #ccc;
    text-align: center;
  }

  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
  }

  .file-item {
    padding: 6px;
    margin-bottom: 5px;
    cursor: pointer;
    background: #fff;
    border: 1px solid #bbb;
    border-radius: 4px;
    font-size: 13px;
  }
  .file-item:hover { background: #e5e5e5; }

  /* SAĞ ÜST (SORU) */
  #rightTop {
    grid-area: rightTop;
    border-bottom: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }

  /* SAĞ ALT (CEVAP) */
  #rightBottom {
    grid-area: rightBottom;
    display: flex;
    flex-direction: column;
  }

  .panel-title {
    padding: 6px 10px;
    background: #f0f0f0;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
    font-size: 14px;
  }

  .img-area {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto !important; /* scroll aktif */
    background: white;
  }

  img {
    max-width: none;
    max-height: none;
  }

  /* SOL ALT GPT PANELİ */
  #leftBottom {
    grid-area: leftBottom;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ccc;
    background: #fafafa;
  }

  #gptTabs {
    display: flex;
    flex-direction: row;
    border-bottom: 1px solid #ccc;
  }

  .gptTabBtn {
    flex: 1;
    padding: 8px;
    border: none;
    background: #e4e4e4;
    cursor: pointer;
    font-weight: bold;
  }

  .gptTabBtn.active {
    background: #ffffff;
    border-bottom: 2px solid #007bff;
  }

  #gptContent {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .gptTabContent {
    padding: 5px;
  }

  /* ZOOM BUTONLARI */
  .zoom-controls {
    position: absolute;
    top: 6px;
    right: 10px;
    z-index: 2;
    display: flex;
    gap: 5px;
  }

  .zoom-btn {
    width: 26px;
    height: 26px;
    background: #fff;
    border: 1px solid #888;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    line-height: 22px;
    text-align: center;
    padding: 0;
  }
</style>
</head>

<body>

<!-- ÜST BAR -->
<div id="topBar">
  <input type="file" id="saFile" accept="application/json">
  <input type="file" id="openaiFile" accept="application/json">
  <button id="loadBtn">PNG Listelerini Yükle</button>
  <button id="runGPTBtn" disabled>GPT Analiz Et</button>
  <span id="status"></span>
</div>

<div id="grid">

  <!-- SOL ÜST -->
  <div id="leftTop">
    <div class="list-column">
      <div class="list-title">SORULAR</div>
      <div id="soruList" class="file-list"></div>
    </div>

    <div class="list-column">
      <div class="list-title">CEVAPLAR</div>
      <div id="cevapList" class="file-list"></div>
    </div>
  </div>

  <!-- SAĞ ÜST SORU -->
  <div id="rightTop">
    <div class="panel-title" id="questionTitle">Soru</div>
    <div class="img-area" id="questionView">
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn('question')">+</button>
        <button class="zoom-btn" onclick="zoomOut('question')">-</button>
      </div>
      <p>Seçilmedi</p>
    </div>
  </div>

  <!-- SOL ALT GPT PANELİ -->
  <div id="leftBottom">

      <div id="gptTabs">
        <button class="gptTabBtn active" onclick="showGptTab('raw')">Ham Cevap</button>
        <button class="gptTabBtn" onclick="showGptTab('processed')">İşlenmiş Cevap</button>
      </div>

      <div id="gptContent">
        <div id="gptRaw" class="gptTabContent">Henüz cevap yok.</div>
        <div id="gptProcessed" class="gptTabContent" style="display:none;">Henüz düzenlenmiş cevap yok.</div>
      </div>

  </div>

  <!-- SAĞ ALT CEVAP -->
  <div id="rightBottom">
    <div class="panel-title" id="answerTitle">Cevap</div>
    <div class="img-area" id="answerView">
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn('answer')">+</button>
        <button class="zoom-btn" onclick="zoomOut('answer')">-</button>
      </div>
      <p>Seçilmedi</p>
    </div>
  </div>

</div>

<script>

/* Sabit folder ID'ler */
const FOLDER_SORULAR = "1SM8NcS58qf-L9wOZ-ywZzg9gKhERZoK3";
const FOLDER_CEVAPLAR = "17IJCUY7xl52-YRyg7lP4FBJ-G3OohPx0";

let saCredentials = null;
let openaiKey = null;

let cacheSorular = [];
let cacheCevaplar = [];

let selectedSoru = null;
let selectedCevap = null;

let zoomLevels = { question: 1.0, answer: 1.0 };

/* JSON Yükleme */
document.getElementById("saFile").onchange = (e) => {
  const reader = new FileReader();
  reader.onload = (x) => {
    saCredentials = JSON.parse(x.target.result);
    document.getElementById("status").textContent = "Service Account JSON yüklendi.";
  };
  reader.readAsText(e.target.files[0]);
};

document.getElementById("openaiFile").onchange = (e) => {
  const reader = new FileReader();
  reader.onload = (x) => {
    openaiKey = JSON.parse(x.target.result).api_key;
    document.getElementById("runGPTBtn").disabled = false;
    document.getElementById("status").textContent = "OpenAI Key JSON yüklendi.";
  };
  reader.readAsText(e.target.files[0]);
};

/* Buton: PNG listesini yükle */
document.getElementById("loadBtn").onclick = async () => {
  cacheSorular = await listPNGs(FOLDER_SORULAR);
  cacheCevaplar = await listPNGs(FOLDER_CEVAPLAR);
  drawLists();
  document.getElementById("status").textContent = "Listeler hazır.";
};

/* Sol taraftaki listeleri çiz */
function drawLists() {
  const sDiv = document.getElementById("soruList");
  const cDiv = document.getElementById("cevapList");
  sDiv.innerHTML = ""; cDiv.innerHTML = "";

  cacheSorular.forEach(f => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = f.name;
    d.onclick = () => showQuestion(f);
    sDiv.appendChild(d);
  });

  cacheCevaplar.forEach(f => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = f.name;
    d.onclick = () => showAnswer(f);
    cDiv.appendChild(d);
  });
}

/* SORU yükle */
async function showQuestion(file) {
  selectedSoru = file;
  zoomLevels.question = 1.0;

  const view = document.getElementById("questionView");
  view.innerHTML = "<p>Yükleniyor...</p>";

  const img = await fetchPNG(file.id);
  document.getElementById("questionTitle").textContent = "Soru: " + file.name;
  view.innerHTML = "";
  view.appendChild(img);
}

/* CEVAP yükle */
async function showAnswer(file) {
  selectedCevap = file;
  zoomLevels.answer = 1.0;

  const view = document.getElementById("answerView");
  view.innerHTML = "<p>Yükleniyor...</p>";

  const img = await fetchPNG(file.id);
  document.getElementById("answerTitle").textContent = "Cevap: " + file.name;
  view.innerHTML = "";
  view.appendChild(img);
}

/* PNG FETCH */
async function fetchPNG(id) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;
  const r = await fetch(url, { headers: { Authorization: "Bearer " + token }});
  const blob = await r.blob();

  const img = document.createElement("img");
  img.src = URL.createObjectURL(blob);

  return img;
}

/* TOKEN al */
let cachedToken = null;
let cachedTokenExp = 0;

async function getToken() {
  const now = Math.floor(Date.now() / 1000);
  if (cachedToken && cachedTokenExp > now) return cachedToken;

  const tokenObj = await createSAJWT(saCredentials);
  cachedToken = tokenObj.access_token;
  cachedTokenExp = now + 3500;
  return cachedToken;
}

/* Drive listeleme */
async function listPNGs(folderId) {
  const token = await getToken();
  const url =
    `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and mimeType='image/png'&fields=files(id,name)&pageSize=500`;
  const r = await fetch(url, { headers: { Authorization: "Bearer " + token }});
  const j = await r.json();
  return j.files || [];
}

/* SA JWT */
async function createSAJWT(sa) {
  const now = Math.floor(Date.now() / 1000);
  const header = { alg:"RS256", typ:"JWT" };
  const payload = {
    iss: sa.client_email,
    scope: "https://www.googleapis.com/auth/drive.readonly",
    aud: "https://oauth2.googleapis.com/token",
    exp: now + 3600,
    iat: now
  };

  const unsigned = b64(JSON.stringify(header)) + "." + b64(JSON.stringify(payload));
  const key = await crypto.subtle.importKey(
    "pkcs8",
    pemToBuf(sa.private_key),
    { name:"RSASSA-PKCS1-v1_5", hash:"SHA-256" },
    false,
    ["sign"]
  );

  const sig = await crypto.subtle.sign("RSASSA-PKCS1-v1_5", key,
      new TextEncoder().encode(unsigned));

  const jwt = unsigned + "." + b64Bytes(sig);

  const r = await fetch("https://oauth2.googleapis.com/token", {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt
    })
  });

  return await r.json();
}

/* Base64 Helper (ceket) */
function b64(str) {
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function b64Bytes(buf) {
  const bytes = new Uint8Array(buf);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
function pemToBuf(pem) {
  const c = pem.replace(/-----.*KEY-----/g,"").replace(/\s+/g,"");
  const b = atob(c);
  const u = new Uint8Array(b.length);
  for (let i=0;i<b.length;i++) u[i]=b.charCodeAt(i);
  return u.buffer;
}

/* ZOOM */
function applyZoom(target) {
  const img = document.getElementById(target+"View").querySelector("img");
  if (img) img.style.transform = `scale(${zoomLevels[target]})`;
}
function zoomIn(target){ zoomLevels[target]+=0.2; applyZoom(target); }
function zoomOut(target){ zoomLevels[target]=Math.max(0.2, zoomLevels[target]-0.2); applyZoom(target); }

/* GPT SEKME */
function showGptTab(which) {
  document.getElementById("gptRaw").style.display = (which==="raw"?"block":"none");
  document.getElementById("gptProcessed").style.display = (which==="processed"?"block":"none");

  document.querySelectorAll(".gptTabBtn").forEach(btn => btn.classList.remove("active"));
  if (which==="raw") document.querySelector(".gptTabBtn:nth-child(1)").classList.add("active");
  else document.querySelector(".gptTabBtn:nth-child(2)").classList.add("active");

  MathJax.typesetPromise();
}

/* PNG to BASE64 */
async function blobToBase64(blob) {
  return new Promise(res=>{
    const r = new FileReader();
    r.onloadend=()=>res(r.result.split(",")[1]);
    r.readAsDataURL(blob);
  });
}

/* GPT TUŞU */
document.getElementById("runGPTBtn").onclick = async () => {
  if (!selectedSoru || !selectedCevap){ alert("Soru ve Cevap seç."); return; }
  document.getElementById("status").textContent = "GPT çalışıyor...";

  /* Base64 oluştur */
  const soruBlob = await fetchPNG(selectedSoru.id).then(()=>fetchPNG(selectedSoru.id));  
  const cevapBlob = await fetchPNG(selectedCevap.id).then(()=>fetchPNG(selectedCevap.id));

  const soruImg = await fetch(`https://www.googleapis.com/drive/v3/files/${selectedSoru.id}?alt=media`,
    { headers: { Authorization:"Bearer "+await getToken() } }).then(r=>r.blob());

  const cevapImg = await fetch(`https://www.googleapis.com/drive/v3/files/${selectedCevap.id}?alt=media`,
    { headers: { Authorization:"Bearer "+await getToken() } }).then(r=>r.blob());

  const soruB64 = await blobToBase64(soruImg);
  const cevapB64 = await blobToBase64(cevapImg);

  /* ÇİFT AŞAMALI GPT ÇALIŞTIR */
  const out = await runGPTFullPipeline(soruB64, cevapB64, openaiKey);

  /* Sol alt panel doldur */
  document.getElementById("gptRaw").innerHTML = marked.parse(out.firstAnswer);
  document.getElementById("gptProcessed").innerHTML = marked.parse(out.finalFormattedAnswer);

  MathJax.typesetPromise();

  document.getElementById("status").textContent = "GPT tamamlandı.";
};


/* GPT ÇİFT AŞAMALI PIPELINE */
async function runGPTFullPipeline(soruBase64, cevapBase64, openaiKey) {

  const firstPrompt = `
Aşağıdaki iki görseli okuyacaksın:
1) Soru Görseli: problem metnini içerir.
2) Cevap Görseli: kullanıcının kendi çözüm notlarını içerir.

Görevlerin:
1) Türkçe 3–5 cümlede soru özeti.
2) Adım adım matematiksel çözüm.
3) Her adım için kısa Türkçe açıklamalar.
4) Tüm formüller Markdown matematik formatında.
5) Sonuç başlığı ile final cevap.
6) Çıktı tamamen Markdown olsun.
`;

  const r1 = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{
      "Authorization":"Bearer "+openaiKey,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {
          role:"user",
          content:[
            {type:"text", text:firstPrompt},
            {type:"image_url", image_url:"data:image/png;base64,"+soruBase64},
            {type:"image_url", image_url:"data:image/png;base64,"+cevapBase64}
          ]
        }
      ]
    })
  }).then(x=>x.json());

  const firstAnswer = r1.choices[0].message.content;


  const secondPrompt = `
Aşağıda sana bir çözüm metni vereceğim. Bu metni ASLA değiştirme.
Sadece yeniden düzenle:

1) Metindeki tüm formülleri bul.
2) Formülleri A, B, C... şeklinde sırala.
3) "## Formülasyon Bölümü" altında:
(A) formül...
(B) formül...
4) "## Metinsel Açıklama Bölümü" altında:
(A) için açıklama...
(B) için açıklama...
5) Metni ve formülü değiştirme, sadece düzenle.
6) Çıktı tamamen Markdown olsun.
`;

  const r2 = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{
      "Authorization":"Bearer "+openaiKey,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        { role:"system", content: secondPrompt },
        { role:"user", content: firstAnswer }
      ]
    })
  }).then(x=>x.json());

  const finalFormattedAnswer = r2.choices[0].message.content;

  return { firstAnswer, finalFormattedAnswer };
}

</script>
</body>
</html>
