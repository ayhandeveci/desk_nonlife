<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Exam Viewer - Soru Cevap</title>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ÜST BAR */
  #topBar {
    position: absolute;
    top: 0;
    left: 0;
    height: 45px;
    width: 100%;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 5px 10px;
    background: #ddd;
    border-bottom: 1px solid #aaa;
    z-index: 3;
  }

  button, input[type="file"] {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #fff;
    font-size: 13px;
  }
  button:hover { background: #e7e7e7; }

  #status { font-size: 12px; margin-left: 10px; }

  #leftSide, #rightSide {
    margin-top: 45px;
    height: calc(100vh - 45px);
  }

  /* SOL TARAF → 2 LİSTE YAN YANA */
  #leftSide {
    width: 460px;
    display: flex;
    flex-direction: row;
    border-right: 1px solid #ccc;
    background: #f3f3f3;
  }

  .list-column {
    flex: none;
    width: 230px;
    min-width: 230px;
    max-width: 230px;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }

  .list-title {
    font-weight: bold;
    padding: 8px;
    background: #e9e9e9;
    border-bottom: 1px solid #ccc;
    text-align: center;
  }

  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
  }

  .file-item {
    padding: 6px;
    margin-bottom: 5px;
    cursor: pointer;
    background: #fff;
    border: 1px solid #bbb;
    border-radius: 4px;
    font-size: 13px;
  }
  .file-item:hover { background: #e5e5e5; }

  /* SAĞ PANEL */
  #rightSide {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .panel {
    flex: 1;
    border-bottom: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .panel-title {
    padding: 6px 10px;
    background: #f0f0f0;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
    font-size: 14px;
  }

  .img-area {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
    background: white;
    position: relative;
  }

  img {
    max-width: 95%;
    max-height: 95%;
    transition: transform 0.15s ease;
  }

  /* Zoom Butonları */
  .zoom-controls {
    position: absolute;
    top: 6px;
    right: 10px;
    z-index: 2;
    display: flex;
    gap: 5px;
  }

  .zoom-btn {
    width: 26px;
    height: 26px;
    background: #fff;
    border: 1px solid #888;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    line-height: 22px;
    text-align: center;
    padding: 0;
  }

  .zoom-btn:hover {
    background: #f0f0f0;
  }
</style>
</head>

<body>

<!-- ÜST BAR -->
<div id="topBar">
  <input type="file" id="saFile" accept="application/json">
  <button id="loadBtn">Tüm PNG Listelerini Yükle</button>
  <span id="status"></span>
</div>

<!-- SOL TARAF (2 LİSTE YAN YANA) -->
<div id="leftSide">

  <div class="list-column">
    <div class="list-title">SORULAR</div>
    <div id="soruList" class="file-list"></div>
  </div>

  <div class="list-column" style="border-right:none;">
    <div class="list-title">CEVAPLAR</div>
    <div id="cevapList" class="file-list"></div>
  </div>

</div>

<!-- SAĞ TARAF -->
<div id="rightSide">

  <div class="panel">
    <div class="panel-title" id="questionTitle">Soru</div>

    <div class="img-area" id="questionView">
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn('question')">+</button>
        <button class="zoom-btn" onclick="zoomOut('question')">-</button>
      </div>
      <p>Seçilmedi</p>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title" id="answerTitle">Cevap</div>

    <div class="img-area" id="answerView">
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn('answer')">+</button>
        <button class="zoom-btn" onclick="zoomOut('answer')">-</button>
      </div>
      <p>Seçilmedi</p>
    </div>
  </div>

</div>

<script>

/* KLASÖR ID'LER */
const FOLDER_SORULAR = "1SM8NcS58qf-L9wOZ-ywZzg9gKhERZoK3";
const FOLDER_CEVAPLAR = "17IJCUY7xl52-YRyg7lP4FBJ-G3OohPx0";

/* CACHE */
let saCredentials = null;
let cacheSorular = [];
let cacheCevaplar = [];
let cachedToken = null;
let cachedTokenExp = 0;

/* ELEMENTLER */
const saFileInput = document.getElementById("saFile");
const loadBtn = document.getElementById("loadBtn");
const soruListDiv = document.getElementById("soruList");
const cevapListDiv = document.getElementById("cevapList");
const statusDiv = document.getElementById("status");
const questionView = document.getElementById("questionView");
const answerView = document.getElementById("answerView");
const questionTitle = document.getElementById("questionTitle");
const answerTitle = document.getElementById("answerTitle");

/* JSON YÜKLEME */
saFileInput.onchange = () => {
  const f = saFileInput.files[0];
  const r = new FileReader();
  r.onload = e => {
    saCredentials = JSON.parse(e.target.result);
    statusDiv.textContent = "JSON yüklendi.";
  };
  r.readAsText(f);
};

/* NUMERİK SIRALAMA */
function sortPngList(list) {
  return list.sort((a, b) => {
    const numA = parseInt(a.name.split('.')[0], 10);
    const numB = parseInt(b.name.split('.')[0], 10);
    return numA - numB;
  });
}

/* PNG LİSTELERİ YÜKLE */
loadBtn.onclick = async () => {
  if (!saCredentials) { alert("Önce JSON yükle."); return; }

  statusDiv.textContent = "Sorular yükleniyor...";
  cacheSorular = sortPngList(await listPNGs(FOLDER_SORULAR));

  statusDiv.textContent = "Cevaplar yükleniyor...";
  cacheCevaplar = sortPngList(await listPNGs(FOLDER_CEVAPLAR));

  statusDiv.textContent = "Listeler hazır.";
  drawLists();
};

/* SOLDA LİSTELERİ ÇİZ */
function drawLists() {
  soruListDiv.innerHTML = "";
  cevapListDiv.innerHTML = "";

  cacheSorular.forEach(item => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = item.name;
    d.onclick = () => showQuestion(item);
    soruListDiv.appendChild(d);
  });

  cacheCevaplar.forEach(item => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = item.name;
    d.onclick = () => showAnswer(item);
    cevapListDiv.appendChild(d);
  });
}

/* SAĞ PANEL SORU */
async function showQuestion(file) {
  questionTitle.textContent = "Soru: " + file.name;
  resetZoom("question");
  questionView.innerHTML = loadingDiv();

  const img = await fetchPNG(file.id);
  questionView.innerHTML = "";
  questionView.appendChild(zoomControls("question"));
  questionView.appendChild(img);
}

/* SAĞ PANEL CEVAP */
async function showAnswer(file) {
  answerTitle.textContent = "Cevap: " + file.name;
  resetZoom("answer");
  answerView.innerHTML = loadingDiv();

  const img = await fetchPNG(file.id);
  answerView.innerHTML = "";
  answerView.appendChild(zoomControls("answer"));
  answerView.appendChild(img);
}

/* YÜKLENİYOR GÖRSELİ */
function loadingDiv() {
  const p = document.createElement("p");
  p.textContent = "Yükleniyor...";
  return p;
}

/* GÖRSEL İNDİRME */
async function fetchPNG(id) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;

  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });

  const blob = await res.blob();
  const img = document.createElement("img");
  img.src = URL.createObjectURL(blob);
  img.style.transform = "scale(1)";
  img.dataset.scale = "1";
  return img;
}

/* DRIVE PNG LİSTESİ */
async function listPNGs(folderId) {
  const token = await getToken();
  const url =
    `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and mimeType='image/png'&fields=files(id,name)&pageSize=500`;

  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });

  return (await res.json()).files || [];
}

/* TOKEN YÖNETİMİ */
async function getToken() {
  const now = Math.floor(Date.now() / 1000);
  if (cachedToken && cachedTokenExp - 60 > now) return cachedToken;

  const t = await createToken(saCredentials);
  cachedToken = t.access_token;
  cachedTokenExp = now + (t.expires_in || 3600);
  return cachedToken;
}

async function createToken(sa) {
  const now = Math.floor(Date.now() / 1000);

  const header = { alg: "RS256", typ: "JWT" };
  const payload = {
    iss: sa.client_email,
    scope: "https://www.googleapis.com/auth/drive.readonly",
    aud: "https://oauth2.googleapis.com/token",
    exp: now + 3600,
    iat: now,
  };

  const unsigned =
    b64(JSON.stringify(header)) + "." + b64(JSON.stringify(payload));

  const key = await crypto.subtle.importKey(
    "pkcs8",
    pemToBuf(sa.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const sig = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    key,
    new TextEncoder().encode(unsigned)
  );

  const jwt = unsigned + "." + b64Bytes(sig);

  const res = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
    }),
  });

  return await res.json();
}

/* HELPER FONKSİYONLAR */
function b64(str) {
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

function b64Bytes(ab) {
  let s = "",
    b = new Uint8Array(ab);
  for (let i = 0; i < b.length; i++) s += String.fromCharCode(b[i]);
  return btoa(s)
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

function pemToBuf(pem) {
  const c = pem
    .replace(/-----BEGIN PRIVATE KEY-----/, "")
    .replace(/-----END PRIVATE KEY-----/, "")
    .replace(/\s+/g, "");
  const bin = atob(c);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

/* --------------------------
   ZOOM FONKSİYONLARI
--------------------------- */
let zoomLevels = { question: 1, answer: 1 };

function zoomControls(target) {
  const div = document.createElement("div");
  div.className = "zoom-controls";

  div.innerHTML = `
    <button class="zoom-btn" onclick="zoomIn('${target}')">+</button>
    <button class="zoom-btn" onclick="zoomOut('${target}')">-</button>
  `;

  return div;
}

function zoomIn(target) {
  zoomLevels[target] = Math.min(zoomLevels[target] + 0.2, 4);
  applyZoom(target);
}

function zoomOut(target) {
  zoomLevels[target] = Math.max(zoomLevels[target] - 0.2, 0.5);
  applyZoom(target);
}

function resetZoom(target) {
  zoomLevels[target] = 1;
}

function applyZoom(target) {
  const viewer = document.getElementById(
    target === "question" ? "questionView" : "answerView"
  );
  const img = viewer.querySelector("img");
  if (!img) return;

  img.style.transform = `scale(${zoomLevels[target]})`;
  img.style.transformOrigin = "center center";
}

</script>
</body>
</html>
