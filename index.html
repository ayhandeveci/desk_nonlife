<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Exam Viewer - Soru Cevap + GPT</title>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    height: 100vh;
    overflow: hidden;
  }

  /* ÜST BAR */
  #topBar {
    position: fixed;
    top: 0;
    left: 0;
    height: 45px;
    width: 100%;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 5px 10px;
    background: #ddd;
    border-bottom: 1px solid #aaa;
    z-index: 10;
  }

  button, input[type="file"] {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #fff;
    font-size: 13px;
  }
  button:hover { background: #e7e7e7; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  #status { font-size: 12px; margin-left: 10px; }

  /* 4'LÜ GRID LAYOUT */
  #grid {
    position: absolute;
    top: 45px;
    left: 0;
    right: 0;
    bottom: 0;
    display: grid;
    grid-template-columns: 35% 65%;
    grid-template-rows: 50% 50%;
    grid-template-areas:
      "leftTop rightTop"
      "leftBottom rightBottom";
  }

  #leftTop {
    grid-area: leftTop;
    border-right: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    background: #f3f3f3;
    padding: 8px;
    display: flex;
    flex-direction: column;
  }

  #rightTop {
    grid-area: rightTop;
    border-bottom: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }

  #leftBottom {
    grid-area: leftBottom;
    border-right: 1px solid #ccc;
    padding: 8px;
    display: flex;
    flex-direction: column;
    background: #f9f9f9;
  }

  #rightBottom {
    grid-area: rightBottom;
    display: flex;
    flex-direction: column;
  }

  /* Sol üst: iki liste yan yana */
  .lists-wrapper {
    flex: 1;
    display: flex;
    flex-direction: row;
  }

  .list-column {
    flex: 1;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }
  .list-column:last-child { border-right: none; }

  .list-title {
    font-weight: bold;
    padding: 6px;
    background: #e9e9e9;
    border-bottom: 1px solid #ccc;
    text-align: center;
    font-size: 14px;
  }

  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
  }

  .file-item {
    padding: 6px;
    margin-bottom: 5px;
    cursor: pointer;
    background: #fff;
    border: 1px solid #bbb;
    border-radius: 4px;
    font-size: 13px;
  }
  .file-item:hover { background: #e5e5e5; }

  /* Soru / Cevap panelleri */
  .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .panel-title {
    padding: 6px 10px;
    background: #f0f0f0;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
    font-size: 14px;
  }

  .img-area {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
    background: white;
    position: relative;
  }

  img {
    max-width: 95%;
    max-height: 95%;
    transition: transform 0.15s ease;
  }

  /* Zoom butonları */
  .zoom-controls {
    position: absolute;
    top: 6px;
    right: 10px;
    z-index: 2;
    display: flex;
    gap: 5px;
  }

  .zoom-btn {
    width: 26px;
    height: 26px;
    background: #fff;
    border: 1px solid #888;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    line-height: 22px;
    text-align: center;
    padding: 0;
  }
  .zoom-btn:hover { background: #f0f0f0; }

  /* GPT PANELİ (SOL ALT) */
  #gptHeader {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 13px;
  }

  #gptHeader span.title {
    font-weight: bold;
    font-size: 14px;
  }

  #gptStatus {
    font-size: 12px;
    margin-left: 6px;
  }

  #gptOutput {
    flex: 1;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #fff;
    padding: 8px 10px;
    overflow-y: auto;
    font-size: 14px;
  }

  #gptOutput h1, #gptOutput h2, #gptOutput h3 {
    margin-top: 10px;
  }

  #gptOutput pre {
    background: #f5f5f5;
    padding: 6px;
    border-radius: 4px;
    overflow-x: auto;
  }
</style>

<!-- Markdown-it -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

<!-- MathJax (LaTeX için) -->
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>

<!-- ÜST BAR -->
<div id="topBar">
  <input type="file" id="saFile" accept="application/json">
  <button id="loadBtn">Tüm PNG Listelerini Yükle</button>
  <span id="status"></span>
</div>

<!-- 4'LÜ GRID -->
<div id="grid">

  <!-- SOL ÜST: SORU/CEVAP LİSTELERİ -->
  <div id="leftTop">
    <div class="lists-wrapper">
      <div class="list-column">
        <div class="list-title">SORULAR</div>
        <div id="soruList" class="file-list"></div>
      </div>
      <div class="list-column">
        <div class="list-title">CEVAPLAR</div>
        <div id="cevapList" class="file-list"></div>
      </div>
    </div>
  </div>

  <!-- SAĞ ÜST: SORU PNG PANELİ -->
  <div id="rightTop">
    <div class="panel">
      <div class="panel-title" id="questionTitle">Soru</div>
      <div class="img-area" id="questionView">
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomIn('question')">+</button>
          <button class="zoom-btn" onclick="zoomOut('question')">-</button>
        </div>
        <p>Seçilmedi</p>
      </div>
    </div>
  </div>

  <!-- SOL ALT: GPT PANELİ -->
  <div id="leftBottom">
    <div id="gptHeader">
      <span class="title">GPT Çözüm Paneli</span>
      <input type="file" id="gptFile" accept="application/json">
      <button id="gptBtn" disabled>GPT Çözüm Üret</button>
      <span id="gptStatus"></span>
    </div>
    <div id="gptOutput">
      GPT cevabı burada görünecek.
    </div>
  </div>

  <!-- SAĞ ALT: CEVAP PNG PANELİ -->
  <div id="rightBottom">
    <div class="panel">
      <div class="panel-title" id="answerTitle">Cevap</div>
      <div class="img-area" id="answerView">
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomIn('answer')">+</button>
          <button class="zoom-btn" onclick="zoomOut('answer')">-</button>
        </div>
        <p>Seçilmedi</p>
      </div>
    </div>
  </div>

</div>

<script>
/* ------------- SABİT FOLDER ID'LER ------------- */
const FOLDER_SORULAR = "1SM8NcS58qf-L9wOZ-ywZzg9gKhERZoK3";
const FOLDER_CEVAPLAR = "17IJCUY7xl52-YRyg7lP4FBJ-G3OohPx0";

/* ------------- DEĞİŞKENLER ------------- */
let saCredentials = null;
let cacheSorular = [];
let cacheCevaplar = [];
let cachedToken = null;
let cachedTokenExp = 0;

let currentQuestionFile = null;
let currentAnswerFile = null;

let zoomLevels = { question: 1, answer: 1 };

let openAIApiKey = null;
const md = window.markdownit({ html: false, linkify: true, breaks: true });

/* ------------- ELEMENTLER ------------- */
const saFileInput   = document.getElementById("saFile");
const loadBtn       = document.getElementById("loadBtn");
const soruListDiv   = document.getElementById("soruList");
const cevapListDiv  = document.getElementById("cevapList");
const statusDiv     = document.getElementById("status");
const questionView  = document.getElementById("questionView");
const answerView    = document.getElementById("answerView");
const questionTitle = document.getElementById("questionTitle");
const answerTitle   = document.getElementById("answerTitle");

const gptFileInput  = document.getElementById("gptFile");
const gptBtn        = document.getElementById("gptBtn");
const gptStatus     = document.getElementById("gptStatus");
const gptOutput     = document.getElementById("gptOutput");

/* ------------- SERVICE ACCOUNT JSON YÜKLEME ------------- */
saFileInput.onchange = () => {
  const f = saFileInput.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    saCredentials = JSON.parse(e.target.result);
    statusDiv.textContent = "Drive JSON yüklendi.";
  };
  r.readAsText(f);
};

/* ------------- OPENAI JSON YÜKLEME ------------- */
gptFileInput.onchange = () => {
  const f = gptFileInput.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      openAIApiKey = data.api_key || data.OPENAI_API_KEY || data.key;
      if (openAIApiKey) {
        gptStatus.textContent = "GPT anahtarı yüklendi.";
        updateGptButtonState();
      } else {
        gptStatus.textContent = "JSON içinde api_key bulunamadı.";
      }
    } catch (err) {
      gptStatus.textContent = "Geçersiz JSON.";
    }
  };
  r.readAsText(f);
};

/* ------------- PNG SIRALAMA ------------- */
function sortPngList(list) {
  return list.sort((a, b) => {
    const numA = parseInt(a.name.split('.')[0], 10);
    const numB = parseInt(b.name.split('.')[0], 10);
    return numA - numB;
  });
}

/* ------------- TÜM PNG LİSTESİNİ YÜKLE ------------- */
loadBtn.onclick = async () => {
  if (!saCredentials) { alert("Önce Drive JSON yükle."); return; }

  statusDiv.textContent = "Sorular yükleniyor...";
  cacheSorular = sortPngList(await listPNGs(FOLDER_SORULAR));

  statusDiv.textContent = "Cevaplar yükleniyor...";
  cacheCevaplar = sortPngList(await listPNGs(FOLDER_CEVAPLAR));

  statusDiv.textContent = "Listeler hazır.";
  drawLists();
};

function drawLists() {
  soruListDiv.innerHTML = "";
  cevapListDiv.innerHTML = "";

  cacheSorular.forEach(item => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = item.name;
    d.onclick = () => showQuestion(item);
    soruListDiv.appendChild(d);
  });

  cacheCevaplar.forEach(item => {
    const d = document.createElement("div");
    d.className = "file-item";
    d.textContent = item.name;
    d.onclick = () => showAnswer(item);
    cevapListDiv.appendChild(d);
  });
}

/* ------------- SORU GÖSTER ------------- */
async function showQuestion(file) {
  currentQuestionFile = file;
  updateGptButtonState();

  questionTitle.textContent = "Soru: " + file.name;
  resetZoom("question");
  questionView.innerHTML = "<p>Yükleniyor...</p>";

  const img = await fetchPNG(file.id);
  questionView.innerHTML = "";
  questionView.appendChild(createZoomControls("question"));
  questionView.appendChild(img);
}

/* ------------- CEVAP GÖSTER ------------- */
async function showAnswer(file) {
  currentAnswerFile = file;
  updateGptButtonState();

  answerTitle.textContent = "Cevap: " + file.name;
  resetZoom("answer");
  answerView.innerHTML = "<p>Yükleniyor...</p>";

  const img = await fetchPNG(file.id);
  answerView.innerHTML = "";
  answerView.appendChild(createZoomControls("answer"));
  answerView.appendChild(img);
}

/* ------------- PNG İNDİR (IMG ELEMENTİ) ------------- */
async function fetchPNG(id) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;

  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });

  const blob = await res.blob();
  const img = document.createElement("img");
  img.src = URL.createObjectURL(blob);
  img.style.transform = "scale(1)";
  return img;
}

/* ------------- PNG İNDİR (BASE64) ------------- */
async function fetchPNGBase64(id) {
  const token = await getToken();
  const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`;

  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });
  const blob = await res.blob();
  return blobToBase64(blob);
}

function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64 = reader.result.split(",")[1];
      resolve(base64);
    };
    reader.readAsDataURL(blob);
  });
}

/* ------------- DRIVE PNG LİSTELEME ------------- */
async function listPNGs(folderId) {
  const token = await getToken();
  const url =
    `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and mimeType='image/png'&fields=files(id,name)&pageSize=500`;

  const res = await fetch(url, {
    headers: { Authorization: "Bearer " + token }
  });

  return (await res.json()).files || [];
}

/* ------------- TOKEN YÖNETİMİ ------------- */
async function getToken() {
  const now = Math.floor(Date.now() / 1000);
  if (cachedToken && cachedTokenExp - 60 > now) return cachedToken;

  const t = await createToken(saCredentials);
  cachedToken = t.access_token;
  cachedTokenExp = now + (t.expires_in || 3600);
  return cachedToken;
}

async function createToken(sa) {
  const now = Math.floor(Date.now() / 1000);

  const header = { alg: "RS256", typ: "JWT" };
  const payload = {
    iss: sa.client_email,
    scope: "https://www.googleapis.com/auth/drive.readonly",
    aud: "https://oauth2.googleapis.com/token",
    exp: now + 3600,
    iat: now,
  };

  const unsigned =
    b64(JSON.stringify(header)) + "." + b64(JSON.stringify(payload));

  const key = await crypto.subtle.importKey(
    "pkcs8",
    pemToBuf(sa.private_key),
    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
    false,
    ["sign"]
  );

  const sig = await crypto.subtle.sign(
    "RSASSA-PKCS1-v1_5",
    key,
    new TextEncoder().encode(unsigned)
  );

  const jwt = unsigned + "." + b64Bytes(sig);

  const res = await fetch("https://oauth2.googleapis.com/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt,
    }),
  });

  return await res.json();
}

/* ------------- HELPER FONKSİYONLAR ------------- */
function b64(str) {
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

function b64Bytes(ab) {
  let s = "",
    b = new Uint8Array(ab);
  for (let i = 0; i < b.length; i++) s += String.fromCharCode(b[i]);
  return btoa(s)
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=+$/g, "");
}

function pemToBuf(pem) {
  const c = pem
    .replace(/-----BEGIN PRIVATE KEY-----/, "")
    .replace(/-----END PRIVATE KEY-----/, "")
    .replace(/\s+/g, "");
  const bin = atob(c);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

/* ------------- ZOOM FONKSİYONLARI ------------- */
function createZoomControls(target) {
  const div = document.createElement("div");
  div.className = "zoom-controls";
  div.innerHTML = `
    <button class="zoom-btn" onclick="zoomIn('${target}')">+</button>
    <button class="zoom-btn" onclick="zoomOut('${target}')">-</button>
  `;
  return div;
}

function zoomIn(target) {
  zoomLevels[target] = Math.min(zoomLevels[target] + 0.2, 4);
  applyZoom(target);
}

function zoomOut(target) {
  zoomLevels[target] = Math.max(zoomLevels[target] - 0.2, 0.5);
  applyZoom(target);
}

function resetZoom(target) {
  zoomLevels[target] = 1;
  applyZoom(target);
}

function applyZoom(target) {
  const viewer = document.getElementById(
    target === "question" ? "questionView" : "answerView"
  );
  const img = viewer.querySelector("img");
  if (!img) return;
  img.style.transform = `scale(${zoomLevels[target]})`;
  img.style.transformOrigin = "center center";
}

/* ------------- GPT BUTON STATE ------------- */
function updateGptButtonState() {
  const ok = !!(openAIApiKey && currentQuestionFile && currentAnswerFile);
  gptBtn.disabled = !ok;
}

/* ------------- GPT ÇALIŞTIR ------------- */
gptBtn.onclick = async () => {
  if (!openAIApiKey || !currentQuestionFile || !currentAnswerFile) return;

  gptStatus.textContent = "Görseller hazırlanıyor...";
  gptOutput.textContent = "GPT isteği hazırlanıyor...";

  try {
    const [qB64, aB64] = await Promise.all([
      fetchPNGBase64(currentQuestionFile.id),
      fetchPNGBase64(currentAnswerFile.id)
    ]);

    gptStatus.textContent = "GPT'ye gönderiliyor...";

    const promptText = `
Aşağıda iki görsel veriyorum:
1) Soru PNG (sınav sorusu metni)
2) Cevap PNG (kullanıcının çözümü / notları)

Görevlerin:

1) Önce soruyu Türkçe olarak kısa, net ve anlaşılır şekilde 3–5 cümlede özetle.
2) Ardından sorunun tam çözümünü adım adım matematiksel olarak doğru biçimde yaz.
3) Her adımın altına mutlaka kısa Türkçe açıklama ekle.
4) Hesaplamalarda LaTeX benzeri matematiksel gösterim kullan. Örneğin:

$$
P(X = k) = (1-p)^{k-1} p
$$

5) Çözümün sonunda "Sonuç:" başlığı ile nihai cevabı açıkla.
6) Çıktının tamamını sadece Markdown formatında ver. HTML verme.
`;

    const body = {
      model: "gpt-4o-mini",
      messages: [
        {
          role: "user",
          content: [
            { type: "text", text: promptText },
            {
              type: "image_url",
              image_url: { url: "data:image/png;base64," + qB64 }
            },
            {
              type: "image_url",
              image_url: { url: "data:image/png;base64," + aB64 }
            }
          ]
        }
      ]
    };

    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + openAIApiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const errText = await res.text();
      gptStatus.textContent = "GPT hata verdi.";
      gptOutput.textContent = errText;
      return;
    }

    const data = await res.json();
    const text = data.choices[0].message.content || "";

    const html = md.render(text);
    gptOutput.innerHTML = html;
    gptStatus.textContent = "GPT cevabı hazır.";

    if (window.MathJax && window.MathJax.typesetPromise) {
      MathJax.typesetPromise([gptOutput]);
    }

  } catch (err) {
    console.error(err);
    gptStatus.textContent = "GPT isteği sırasında hata.";
    gptOutput.textContent = String(err);
  }
};
</script>

</body>
</html>
